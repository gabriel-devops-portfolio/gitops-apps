#!/bin/bash
# Entrypoint script to build args for Penumbra's pd,
# based on StatefulSet k8s ordinal.
set -euo pipefail


if ! [[ $HOSTNAME =~ -([0-9]+)$ ]] ; then
    >&2 echo "ERROR: hostname did not have a numeric suffix"
    exit 1
fi

# Disable shellcheck for unused variable; it can't tell we use the var
# in the jq command below.
# shellcheck disable=SC2034
statefulset_ordinal="${BASH_REMATCH[1]}"

# Raw Helm vars translated to JSON representation in this file.
node_info_filepath="/opt/penumbra/nodes.json"

>&2 echo "Configuring node '$statefulset_ordinal' with node info:"
jq < "$node_info_filepath"

# Unpack the JSON Helm vars as Bash env vas.
function get_var() {
    local v
    local json_address
    json_address="${1:-}"
    shift 1
    v="$(jq -r ".[$statefulset_ordinal].$json_address" "$node_info_filepath")"
    if [[ $v = "null" ]]; then
        v=""
    fi
    echo "$v"
}

external_address_flag=""
external_address="$(get_var "external_address")"
if [[ -n $external_address ]] ; then
    external_address_flag="--external-address $external_address"
fi

moniker_flag=""
moniker="$(get_var "moniker")"
if [[ -n $moniker ]] ; then
    moniker_flag="--moniker $moniker"
fi

seed_mode="$(get_var "seed_mode")"
if [[ "$seed_mode" = "true" ]] ; then
    seed_mode="true"
else
    seed_mode="false"
fi


penumbra_network_dir="/home/penumbra/.penumbra/network_data"
# we must write into a subdir of the volumeMount, because the "--network-dir" arg
# to "pd network join" must point to a non-existent directory, and the volumeMount
# will always exist.
#
if ! test -d "$penumbra_network_dir" ; then
    echo "No pre-existing network data, pulling fresh info"
    # shellcheck disable=SC2086
    pd network --network-dir "$penumbra_network_dir" join \
        --tendermint-p2p-bind 0.0.0.0:26656 \
        --tendermint-rpc-bind 0.0.0.0:26657 \
        $external_address_flag \
        $moniker_flag \
        "$PENUMBRA_BOOTSTRAP_URL"

    # This config_file definition is for the *initial* creation path
    config_file="${penumbra_network_dir}/node0/cometbft/config/config.toml"  
    >&2 echo "--- DEBUG: config.toml content immediately after pd network join (fresh setup) ---"
    >&2 echo "Path: ${config_file}"
    ls -l "${config_file}" || true
    cat "${config_file}" || true
    >&2 echo "--- DEBUG: End of initial config.toml verification (fresh setup) ---"

    if [[ -n "${PENUMBRA_CUSTOM_ARCHIVE_URL:-}" ]] ; then
        dest_archive="${penumbra_network_dir}/$(basename "$PENUMBRA_CUSTOM_ARCHIVE_URL")"
        >&2 echo "Downloading archive from $PENUMBRA_CUSTOM_ARCHIVE_URL ..."
        while true; do sleep 300; ls -sh "$dest_archive"; done &
        curl -# -sSfL -o "$dest_archive" "$PENUMBRA_CUSTOM_ARCHIVE_URL"
        >&2 echo "Extracting archive..."
        tar -xzf "$dest_archive" -C "${penumbra_network_dir}/node0/"
        >&2 echo "Done, archive extracted"
    fi

else # Directory already exists, skip "pd network join"
    echo "Pre-existing network data found in '$penumbra_network_dir', skipping 'pd network join'."
    # Define config_file for existing data scenario
    config_file="${penumbra_network_dir}/node0/cometbft/config/config.toml"
    >&2 echo "--- DEBUG: config.toml content from existing network data ---"
    >&2 echo "Path: ${config_file}"
    ls -l "${config_file}" || true
    cat "${config_file}" || true
    >&2 echo "--- DEBUG: End of existing config.toml verification ---"
fi

# set ownership for pd user
chown -R 1000:1000 "$penumbra_network_dir"

# Now, we proceed with modifications regardless of whether the directory was new or existed.
# These operations must happen AFTER the initial network data is pulled/checked.

# Apply external address and moniker (always run)
sed -i -e "s/external_address.*/external_address = \"$external_address\"/" "${penumbra_network_dir}/node0/cometbft/config/config.toml"
sed -i -e "s/moniker.*/moniker = \"$moniker\"/" "${penumbra_network_dir}/node0/cometbft/config/config.toml"

# configure peer settings (always run)
sed -i -e "s/max_num_inbound_peers.*/max_num_inbound_peers = $COMETBFT_CONFIG_P2P_MAX_NUM_INBOUND_PEERS/" "${penumbra_network_dir}/node0/cometbft/config/config.toml"
sed -i -e "s/max_num_outbound_peers.*/max_num_outbound_peers = $COMETBFT_CONFIG_P2P_MAX_NUM_OUTBOUND_PEERS/" "${penumbra_network_dir}/node0/cometbft/config/config.toml"

# configure seed node, defaulting to false if unspecified. (always run)
sed -i -e "s/^seed_mode.*/seed_mode = $seed_mode/" "${penumbra_network_dir}/node0/cometbft/config/config.toml"


# Always check and set psql indexer if enabled - MOVED THIS BLOCK OUTSIDE THE INITIAL IF/ELSE
if [[ "$PENUMBRA_COMETBFT_INDEXER" = "psql" ]] ; then
    # config_file is already set by the initial if/else block above.

    # Check if [tx_index] section exists
    if ! grep -q '\[tx_index\]' "$config_file"; then
        # If not, append it to the end of the file
        echo -e "\n[tx_index]" >> "$config_file"
    fi

    # *** THIS IS THE CRITICAL DEBUG LINE FOR THE ENVIRONMENT VARIABLE ***
    >&2 echo "DEBUG: COMETBFT_POSTGRES_CONNECTION_URL environment variable value: ${COMETBFT_POSTGRES_CONNECTION_URL}"

    # Now, use awk to ensure indexer and psql-conn are correctly set within [tx_index]
    awk -v psql_conn="$COMETBFT_POSTGRES_CONNECTION_URL" '
    /\[tx_index\]/{
        print;
        found_tx_index=1;
        next;
    }
    found_tx_index && !/\[.*\]/{
        if ($1 == "indexer") {
            $0 = "indexer = \"psql\"";
            found_indexer=1;
        } else if ($1 == "psql-conn") {
            $0 = "psql-conn = \"" psql_conn "\"";
            found_psql_conn=1;
        }
        print;
        next;
    }
    /\[.*\]/{
        if (found_tx_index) {
            if (!found_indexer) print "indexer = \"psql\"";
            if (!found_psql_conn) print "psql-conn = \"" psql_conn "\"";
        }
        found_tx_index=0;
        found_indexer=0;
        found_psql_conn=0;
        print;
        next;
    }
    END {
        if (found_tx_index && (!found_indexer || !found_psql_conn)) {
            if (!found_indexer) print "indexer = \"psql\"";
            if (!found_psql_conn) print "psql-conn = \"" psql_conn "\"";
        }
    }
    1' "$config_file" > "${config_file}.tmp" && mv "${config_file}.tmp" "$config_file"
fi


# Fix Prometheus configuration - completely rebuild the instrumentation section
config_file="${penumbra_network_dir}/node0/cometbft/config/config.toml"
temp_file="${config_file}.temp"

echo "---- BEGIN config.toml BEFORE instrumentation fix ----"
cat "${config_file}" || echo "config.toml not found or cat failed"
echo "---- END config.toml BEFORE instrumentation fix ----"

# Extract file content without the instrumentation section
sed -e '/^\[instrumentation\]/,/^\[.*\]/d' "${config_file}" > "${temp_file}"

# Add a clean instrumentation section at the end
echo "" >> "${temp_file}"
echo "[instrumentation]" >> "${temp_file}"

# Use the environment variable to set prometheus value
if [[ "${COMETBFT_CONFIG_INSTRUMENTATION_PROMETHEUS}" == "true" ]]; then
    echo "prometheus = true" >> "${temp_file}"
    echo "prometheus_listen_addr = \":26660\"" >> "${temp_file}"
    echo "max_open_connections = 3" >> "${temp_file}"
    echo "namespace = \"tendermint\"" >> "${temp_file}"
else
    echo "prometheus = false" >> "${temp_file}"
fi

echo "" >> "${temp_file}"

# Move the fixed file back
mv "${temp_file}" "${config_file}"

echo "---- BEGIN config.toml AFTER instrumentation fix ----"
cat "${config_file}" || echo "config.toml not found or cat failed"
echo "---- END config.toml AFTER instrumentation fix ----"

# set ownership for cometbft configs to match cometbft container "tmuser" uid/gid
chown -R 101:1000 "${penumbra_network_dir}/node0/cometbft"