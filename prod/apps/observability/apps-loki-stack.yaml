application: loki-distributed
clusterConfig:
  namespace: monitoring
chart:
  name: loki-distributed
  releaseName: loki
  repoURL: https://grafana.github.io/helm-charts
  targetRevision: 0.80.6
  values: |
    config:
      logLevel: info
      logFormat: logfmt

    loki:
      serviceAccount:
        create: true
        name: loki
        annotations:
          eks.amazonaws.com/role-arn: arn:aws:iam::<AWS_ACCOUNT_ID>:role/<LOKI_ROLE_NAME>

      commonConfig:
        replication_factor: 3

      podDisruptionBudget:
        enabled: true
        minAvailable: 1

      resources:
        requests:
          cpu: 500m
          memory: 1Gi
        limits:
          cpu: 1
          memory: 2Gi

      securityContext:
        runAsNonRoot: true
        runAsUser: 65532
        fsGroup: 65532
        readOnlyRootFilesystem: true
        allowPrivilegeEscalation: false

      storage:
        type: s3
        s3:
          bucketnames: loki-prod-logs
          region: us-east-1
          insecure: false
          s3forcepathstyle: false

      schemaConfig:
        configs:
          - from: 2024-01-01
            store: boltdb-shipper
            object_store: s3
            schema: v11
            index:
              prefix: loki_index_
              period: 24h

      storageConfig:
        boltdb_shipper:
          shared_store: s3
          active_index_directory: /var/loki/index
          cache_location: /var/loki/cache
          cache_ttl: 168h

      limits_config:
        ingestion_rate_mb: 10
        ingestion_burst_size_mb: 20
        per_stream_rate_limit: 5MB
        per_stream_rate_limit_burst: 15MB
        retention_period: 2160h

      ingester:
        wal:
          enabled: true
          dir: /var/loki/wal
        chunk_idle_period: 30m
        chunk_block_size: 262144
        max_transfer_retries: 0
        persistence:
          enabled: true
          size: 100Gi
          storageClass: gp3-kms

      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
          interval: 30s
          scrapeTimeout: 10s
          selector:
            matchLabels:
              release: kube-prometheus-stack
          namespaceSelector:
            matchNames:
              - monitoring

    distributor:
      replicas: 3
      resources:
        requests:
          cpu: 250m
          memory: 512Mi
        limits:
          cpu: 500m
          memory: 1Gi

    querier:
      replicas: 3
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
        limits:
          cpu: 1
          memory: 2Gi

    compactor:
      replicas: 1
      resources:
        requests:
          cpu: 500m
          memory: 512Mi
        limits:
          cpu: 1
          memory: 1Gi
